# テストスクリプトについて

テストは TAP（Test Anything Protocol）を用いて行います．

## How to Run

Run `make check` at the root directory of the project.

## 概要

Automake の TAP を用いて，自動的にテストを行います．

コンパイルを毎回しなくとも良いようにテストケースごとにファイルに分け，
make によって監視しています．

lmntest ファイルをコンパイルする必要がある場合は，
[create_testdata.awk](system_check/create_testdata.awk)
スクリプトによって正当な LMNtal プログラムへと作り替えます．

この作り替えられたプログラムはテストが正しく行われた場合，
最終状態のプロセスに `ok` を含みます．

check.pl は，
lmntest から作成された il ファイルを slim に与えて実行し，
結果に `ok` があるかどうかを検査します．

## 新たなテストが必要な場合

新たなテストが必要な場合は，

1. Makefile.am の TESTS 変数にスクリプトを追加し，
   TAP にしたがって結果を出力してください．
2. LMNtal プログラムのテストを追加する場合は，
   system_check ディレクトリ以下に
   1. `.lmntest` ファイルと
   2. `check.sh` ファイルを追加してください．
3. その上で，
   Makefile.am の TESTS 変数に追加した check.sh ファイルを，
   check_DATA 変数に追加した .lmntest ファイルを追加してください．
4. check.sh ファイルは `./check.pl` を呼び出し，
   引数として全てのテストしたい `.lmntest` ファイルを一度に与えてください．
5. .lmntest ファイルは，
   1. １行目にテストしたい LMNtal プログラム，
   2. ２行目に LMNtal プログラムの予想される出力，
   3. ３行目に `ok` または `ng` を記述してください．
      - `ok` は１行目の結果が２行目と等しいとき，
      - `ng` は１行目の結果が２行目と異なるときにテストに成功します．
   4. ４行目以降には LMNtal コメント以外は書かないでください．

## 歴史的経緯

元々のテストスクリプトは LMNtal 処理系用のテストスクリプトを流用したもので，
以下のような欠点がありました．

- テストが走るたびに lmn ファイルをコンパイルする
- テストの結果如何にかかわらず PASS: 1 のみを表示する
- ~.log にテスト結果が出力される

１回のテストに５分程度かかるため，
自動テストの利点があまり発揮できていませんでした．

そこで，
Automake の TAP を用いてよりテストの利便性を高めました．

2016/12/30 tomioka
